<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.lyy.manager.modular.system.mapper.StudentMapper">

    <!--    基础resultMap映射-->
    <resultMap id="studentBaseMap" type="com.lyy.manager.modular.system.entity.Student">
        <id property="id" column="id"/>
        <result property="sno" column="sno"/>
        <result property="username" column="username"/>
        <result property="password" column="password"/>
        <result property="name" column="name"/>
        <result property="tel" column="tel"/>
        <result property="avatar" column="avatar"/>
        <result property="add" column="add"/>
        <result property="createTime" column="create_time"/>
        <result property="updateTime" column="update_time"/>
    </resultMap>

    <!--    学生关联一对多查询工单-->
    <resultMap id="studentOrdersMap" type="com.lyy.manager.modular.system.entity.Student" extends="studentBaseMap">
        <collection property="ordersList" ofType="com.lyy.manager.modular.system.entity.Orders">
            <id property="id" column="id"/>
            <result property="mno" column="mno"/>
            <result property="sno" column="sno"/>
            <result property="variety" column="variety"/>
            <result property="picture" column="picture"/>
            <result property="detail" column="detail"/>
            <result property="status" column="status"/>
            <result property="createTime" column="create_time"/>
            <result property="updateTime" column="update_time"/>
            <result property="finishTime" column="finish_time"/>
        </collection>
    </resultMap>

    <!--    sql语句封装-->
    <sql id="baseSql">
        SELECT s.id,
               s.NAME,
               s.ADD,
               s.tel,
               s.sno,
               o.mno,
               o.variety,
               o.STATUS,
               o.detail,
               o.create_time,
               o.finish_time,
               o.update_time,
               o.picture
        FROM student s,
             orders o
        WHERE o.sno = s.sno
    </sql>

    <!--    学生登录-->
    <select id="studentLogin" resultType="com.lyy.manager.modular.system.entity.Student"
            parameterType="com.lyy.manager.modular.system.param.LoginParam">
        SELECT s.id,
               s.name,
               s.add,
               s.tel,
               s.sno
        FROM student s
        WHERE s.username = #{username}
          AND s.`password` = #{password}
    </select>

    <!--    查询自己所有提交过的工单-->
    <select id="studentFindAllOrders" parameterType="String" resultMap="studentOrdersMap">
        <include refid="baseSql"></include>
        AND s.sno = #{sno}
    </select>

    <!--    工单完成状态查询 ==待处理-->
    <select id="studentFindAllNeedFixOrder" parameterType="String" resultMap="studentOrdersMap">
        <include refid="baseSql"></include>
        AND s.sno =#{sno}
        AND o.status='0';
    </select>

    <!--    工单查询 ==根据sno学号查询 正在维修的工单-->
    <select id="studentFindAllFixingOrder" parameterType="String" resultMap="studentOrdersMap">
        <include refid="baseSql"></include>
        AND s.sno = #{sno}
        AND o.status = '1';
    </select>

    <!--    工单完成状态查询 ==已完成-->
    <select id="studentFindAllFinishOrder" parameterType="String" resultMap="studentOrdersMap">
        <include refid="baseSql"></include>
        AND s.sno = #{sno}
        AND o.status = '2';
    </select>

    <!--    工单创建   通过学生学号进行插入  学生学号做了外键约束-->
    <insert id="addOrderByStudentNo" parameterType="com.lyy.manager.modular.system.param.OrdersParam">
        INSERT INTO orders (`sno`, `variety`, `picture`, `detail`)
        VALUES (#{sno}, #{variety}, #{picture}, #{detail})
    </insert>

    <!--    删除-->
    <delete id="delOrderByStudentSnoAndOrderId" parameterType="com.lyy.manager.modular.system.param.OrdersParam">
        DELETE
        FROM orders
        WHERE id = #{id}
          AND sno = #{sno}
    </delete>

</mapper>
